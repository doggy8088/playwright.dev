---
id: test-parallel
title: "平行處理"
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import HTMLCard from '@site/src/components/HTMLCard';
import ProgressiveImage from '@theme/ProgressiveImage';

## 簡介

Playwright Test 平行執行測試。為了達到這一點，它會執行多個同時運行的工作程序。預設情況下，**測試檔案**是平行執行的。單個檔案中的測試會按順序在同一個工作程序中執行。

- 你可以使用 [`test.describe.configure`](#parallelize-tests-in-a-single-file) 配置測試以平行執行**單個檔案中的測試**。
- 你可以使用 [testProject.fullyParallel](/api/class-testproject.mdx#test-project-fully-parallel) 或 [testConfig.fullyParallel](/api/class-testconfig.mdx#test-config-fully-parallel) 配置**整個專案**讓所有檔案中的所有測試都平行執行。
- 要**停用**平行處理，請將[工作程序數量限制為一個](#disable-parallelism)。

你可以控制[平行工作程序的數量](#limit-workers)，並在整個測試套件中[限制失敗次數](#limit-failures-and-fail-fast)以提高效率。

## Worker 程序

所有測試都在工作程序中執行。這些程序是作業系統程序，獨立運行，由測試執行器編排。所有工作程序都具有相同的環境，每個都會啟動自己的瀏覽器。

你無法在工作程序之間進行通訊。Playwright Test 會盡可能重複使用單一工作程序以加快測試速度，因此多個測試檔案通常會在單一工作程序中依序執行。

工作程序總是在[測試失敗](./test-retries.mdx#failures)後關閉，以確保後續測試有乾淨的環境。

## 限制工作程序

你可以透過[命令列](./test-cli.mdx)或在[組態設定檔](./test-configuration.mdx)中控制平行工作程序的最大數量。

從命令列：

```bash
npx playwright test --workers 4
```

在組態設定檔中：

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';

export default defineConfig({
  // 在 CI 上限制工作程序數量，本機使用預設值
  workers: process.env.CI ? 2 : undefined,
});
```

## 停用平行處理

你可以透過僅允許一個工作程序來停用任何平行處理。在組態設定檔中設定 `workers: 1` 選項，或向命令列傳遞 `--workers=1`。

```bash
npx playwright test --workers=1
```

## 平行處理單個檔案中的測試

預設情況下，單個檔案中的測試會按順序執行。如果你在單個檔案中有許多獨立的測試，你可能會想要使用 [test.describe.configure()](/api/class-test.mdx#test-describe-configure) 讓它們平行執行。

請注意，平行測試會在獨立的工作程序中執行，無法共享任何狀態或全域變數。每個測試只會為自己執行所有相關的掛勾，包括 `beforeAll` 和 `afterAll`。

```js
import { test } from '@playwright/test';

test.describe.configure({ mode: 'parallel' });

test('runs in parallel 1', async ({ page }) => { /* ... */ });
test('runs in parallel 2', async ({ page }) => { /* ... */ });
```

或者，你可以在組態設定檔中選擇讓所有測試進入這個完全平行模式：

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';

export default defineConfig({
  fullyParallel: true,
});
```

你也可以只為幾個專案選擇完全平行模式：

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';

export default defineConfig({
  // 讓特定專案的所有檔案中的所有測試都平行執行
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
      fullyParallel: true,
    },
  ]
});
```

## 序列模式

你可以將相互依賴的測試標註為序列執行。如果其中一個序列測試失敗，所有後續測試都會被跳過。群組中的所有測試會一起重試。

:::note

不建議使用序列模式。通常最好讓你的測試保持隔離，這樣它們可以獨立執行。
:::

```js
import { test, type Page } from '@playwright/test';

// 將整個檔案標註為序列執行。
test.describe.configure({ mode: 'serial' });

let page: Page;

test.beforeAll(async ({ browser }) => {
  page = await browser.newPage();
});

test.afterAll(async () => {
  await page.close();
});

test('runs first', async () => {
  await page.goto('https://playwright.dev/');
});

test('runs second', async () => {
  await page.getByText('Get Started').click();
});
```

## 選擇退出完全平行模式

如果你的組態設定使用 [testConfig.fullyParallel](/api/class-testconfig.mdx#test-config-fully-parallel) 對所有測試套用平行模式，你可能仍然想要使用預設設定執行某些測試。你可以在每個 describe 中覆寫模式：

```js
test.describe('runs in parallel with other describes', () => {
  test.describe.configure({ mode: 'default' });
  test('in order 1', async ({ page }) => {});
  test('in order 2', async ({ page }) => {});
});
```

## 在多台機器之間分片測試

Playwright Test 可以分片測試套件，使其能夠在多台機器上執行。請參閱[分片指南](./test-sharding.mdx)了解更多詳細資訊。

```bash
npx playwright test --shard=2/3
```

## 限制失敗並快速失敗

你可以透過設定 `maxFailures` 組態選項或傳遞 `--max-failures` 命令列旗標來限制整個測試套件中失敗測試的數量。

當使用「最大失敗次數」設定執行時，Playwright Test 會在達到這個失敗測試數量後停止，並跳過任何尚未執行的測試。這對於避免在損壞的測試套件上浪費資源很有用。

傳遞命令列選項：

```bash
npx playwright test --max-failures=10
```

在組態設定檔中設定：

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';

export default defineConfig({
  // 在 CI 上限制失敗次數以節省資源
  maxFailures: process.env.CI ? 10 : undefined,
});
```

## Worker 索引和平行索引

每個工作程序被分配兩個 ID：一個從 1 開始的唯一工作程序索引，以及一個介於 `0` 和 `workers - 1` 之間的平行索引。當工作程序重新啟動（例如在失敗後），新的工作程序會有相同的 `parallelIndex` 和新的 `workerIndex`。

你可以從環境變數 `process.env.TEST_WORKER_INDEX` 和 `process.env.TEST_PARALLEL_INDEX` 讀取索引，或透過 [testInfo.workerIndex](/api/class-testinfo.mdx#test-info-worker-index) 和 [testInfo.parallelIndex](/api/class-testinfo.mdx#test-info-parallel-index) 存取它們。

### 隔離平行工作程序之間的測試資料

你可以利用上面提到的 `process.env.TEST_WORKER_INDEX` 或 [testInfo.workerIndex](/api/class-testinfo.mdx#test-info-worker-index) 來隔離不同工作程序上執行的測試之間的資料庫使用者資料。所有由工作程序執行的測試會重複使用相同的使用者。

建立 `playwright/fixtures.ts` 檔案來[建立 `dbUserName` 佈置](./test-fixtures#creating-a-fixture)並在測試資料庫中初始化新使用者。使用 [testInfo.workerIndex](/api/class-testinfo.mdx#test-info-worker-index) 來區分工作程序。

```js title="playwright/fixtures.ts"
import { test as baseTest, expect } from '@playwright/test';
// 匯入專案工具以管理測試資料庫中的使用者。
import { createUserInTestDatabase, deleteUserFromTestDatabase } from './my-db-utils';

export * from '@playwright/test';
export const test = baseTest.extend<{}, { dbUserName: string }>({
  // 回傳工作程序唯一的資料庫使用者名稱。
  dbUserName: [async ({ }, use) => {
    // 使用 workerIndex 作為每個工作程序的唯一識別符。
    const userName = `user-${test.info().workerIndex}`;
    // 在資料庫中初始化使用者。
    await createUserInTestDatabase(userName);
    await use(userName);
    // 測試完成後清理。
    await deleteUserFromTestDatabase(userName);
  }, { scope: 'worker' }],
});
```

現在，每個測試檔案都應該從我們的佈置檔案而不是 `@playwright/test` 匯入 `test`。

```js title="tests/example.spec.ts"
// 重要：匯入我們的佈置。
import { test, expect } from '../playwright/fixtures';

test('test', async ({ dbUserName }) => {
  // 在測試中使用使用者名稱。
});
```

## 控制測試順序

Playwright Test 按照宣告順序執行單個檔案中的測試，除非你[平行處理單個檔案中的測試](#parallelize-tests-in-a-single-file)。

跨檔案的測試執行順序沒有保證，因為 Playwright Test 預設會平行執行測試檔案。但是，如果你[停用平行處理](#disable-parallelism)，你可以透過按字母順序命名檔案或使用「測試清單」檔案來控制測試順序。

### 按字母順序排序測試檔案

當你**停用平行測試執行**時，Playwright Test 會按字母順序執行測試檔案。你可以使用某種命名慣例來控制測試順序，例如 `001-user-signin-flow.spec.ts`、`002-create-new-document.spec.ts` 等等。

### 使用「測試清單」檔案

:::warning

不建議使用測試清單，僅作為盡力而為的支援。某些功能（如 VS Code Extension 和追蹤）可能無法與測試清單正常運作。
:::

你可以將測試放在多個檔案的輔助函式中。考慮以下範例，其中測試不是直接在檔案中定義，而是在包裝函式中定義。

```js title="feature-a.spec.ts"
import { test, expect } from '@playwright/test';

export default function createTests() {
  test('feature-a example test', async ({ page }) => {
    // ... test goes here
  });
}

```

```js title="feature-b.spec.ts"
import { test, expect } from '@playwright/test';

export default function createTests() {
  test.use({ viewport: { width: 500, height: 500 } });

  test('feature-b example test', async ({ page }) => {
    // ... test goes here
  });
}
```

你可以建立一個測試清單檔案來控制測試順序 - 先執行 `feature-b` 測試，然後執行 `feature-a` 測試。請注意每個測試檔案是如何包裝在呼叫定義測試函式的 `test.describe()` 區塊中的。這樣 `test.use()` 呼叫只會影響來自單個檔案的測試。

```js title="test.list.ts"
import { test } from '@playwright/test';
import featureBTests from './feature-b.spec.ts';
import featureATests from './feature-a.spec.ts';

test.describe(featureBTests);
test.describe(featureATests);
```

現在**停用平行執行**，將工作程序設為一個，並指定你的測試清單檔案。

```js title="playwright.config.ts"
import { defineConfig } from '@playwright/test';

export default defineConfig({
  workers: 1,
  testMatch: 'test.list.ts',
});
```

:::note
不要直接在輔助檔案中定義你的測試。這可能會導致意外結果，因為你的測試現在依賴於 `import`/`require` 語句的順序。相反，將測試包裝在一個函式中，該函式將由測試清單檔案顯式呼叫，如上面的範例所示。
:::


[Accessibility]: /api/class-accessibility.mdx "Accessibility"
[Android]: /api/class-android.mdx "Android"
[AndroidDevice]: /api/class-androiddevice.mdx "AndroidDevice"
[AndroidInput]: /api/class-androidinput.mdx "AndroidInput"
[AndroidSocket]: /api/class-androidsocket.mdx "AndroidSocket"
[AndroidWebView]: /api/class-androidwebview.mdx "AndroidWebView"
[APIRequest]: /api/class-apirequest.mdx "APIRequest"
[APIRequestContext]: /api/class-apirequestcontext.mdx "APIRequestContext"
[APIResponse]: /api/class-apiresponse.mdx "APIResponse"
[APIResponseAssertions]: /api/class-apiresponseassertions.mdx "APIResponseAssertions"
[Browser]: /api/class-browser.mdx "Browser"
[BrowserContext]: /api/class-browsercontext.mdx "BrowserContext"
[BrowserServer]: /api/class-browserserver.mdx "BrowserServer"
[BrowserType]: /api/class-browsertype.mdx "BrowserType"
[CDPSession]: /api/class-cdpsession.mdx "CDPSession"
[Clock]: /api/class-clock.mdx "Clock"
[ConsoleMessage]: /api/class-consolemessage.mdx "ConsoleMessage"
[Coverage]: /api/class-coverage.mdx "Coverage"
[Dialog]: /api/class-dialog.mdx "Dialog"
[Download]: /api/class-download.mdx "Download"
[Electron]: /api/class-electron.mdx "Electron"
[ElectronApplication]: /api/class-electronapplication.mdx "ElectronApplication"
[ElementHandle]: /api/class-elementhandle.mdx "ElementHandle"
[FileChooser]: /api/class-filechooser.mdx "FileChooser"
[Frame]: /api/class-frame.mdx "Frame"
[FrameLocator]: /api/class-framelocator.mdx "FrameLocator"
[GenericAssertions]: /api/class-genericassertions.mdx "GenericAssertions"
[JSHandle]: /api/class-jshandle.mdx "JSHandle"
[Keyboard]: /api/class-keyboard.mdx "Keyboard"
[Locator]: /api/class-locator.mdx "Locator"
[LocatorAssertions]: /api/class-locatorassertions.mdx "LocatorAssertions"
[Logger]: /api/class-logger.mdx "Logger"
[Mouse]: /api/class-mouse.mdx "Mouse"
[Page]: /api/class-page.mdx "Page"
[PageAssertions]: /api/class-pageassertions.mdx "PageAssertions"
[Playwright]: /api/class-playwright.mdx "Playwright"
[PlaywrightAssertions]: /api/class-playwrightassertions.mdx "PlaywrightAssertions"
[Request]: /api/class-request.mdx "Request"
[Response]: /api/class-response.mdx "Response"
[Route]: /api/class-route.mdx "Route"
[Selectors]: /api/class-selectors.mdx "Selectors"
[SnapshotAssertions]: /api/class-snapshotassertions.mdx "SnapshotAssertions"
[TimeoutError]: /api/class-timeouterror.mdx "TimeoutError"
[Touchscreen]: /api/class-touchscreen.mdx "Touchscreen"
[Tracing]: /api/class-tracing.mdx "Tracing"
[Video]: /api/class-video.mdx "Video"
[WebError]: /api/class-weberror.mdx "WebError"
[WebSocket]: /api/class-websocket.mdx "WebSocket"
[WebSocketRoute]: /api/class-websocketroute.mdx "WebSocketRoute"
[Worker]: /api/class-worker.mdx "Worker"
[Fixtures]: /api/class-fixtures.mdx "Fixtures"
[FullConfig]: /api/class-fullconfig.mdx "FullConfig"
[FullProject]: /api/class-fullproject.mdx "FullProject"
[Location]: /api/class-location.mdx "Location"
[Test]: /api/class-test.mdx "Test"
[TestConfig]: /api/class-testconfig.mdx "TestConfig"
[TestInfo]: /api/class-testinfo.mdx "TestInfo"
[TestInfoError]: /api/class-testinfoerror.mdx "TestInfoError"
[TestOptions]: /api/class-testoptions.mdx "TestOptions"
[TestProject]: /api/class-testproject.mdx "TestProject"
[TestStepInfo]: /api/class-teststepinfo.mdx "TestStepInfo"
[WorkerInfo]: /api/class-workerinfo.mdx "WorkerInfo"
[Reporter]: /api/class-reporter.mdx "Reporter"
[Suite]: /api/class-suite.mdx "Suite"
[TestCase]: /api/class-testcase.mdx "TestCase"
[TestError]: /api/class-testerror.mdx "TestError"
[TestResult]: /api/class-testresult.mdx "TestResult"
[TestStep]: /api/class-teststep.mdx "TestStep"
[Element]: https://developer.mozilla.org/en-US/docs/Web/API/element "Element"
[EvaluationArgument]: /evaluating.mdx#evaluation-argument "EvaluationArgument"
[Promise]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise "Promise"
[iterator]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols "Iterator"
[origin]: https://developer.mozilla.org/en-US/docs/Glossary/Origin "Origin"
[selector]: https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors "selector"
[Serializable]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#Description "Serializable"
[UIEvent.detail]: https://developer.mozilla.org/en-US/docs/Web/API/UIEvent/detail "UIEvent.detail"
[UnixTime]: https://en.wikipedia.org/wiki/Unix_time "Unix Time"
[xpath]: https://developer.mozilla.org/en-US/docs/Web/XPath "xpath"

[Array]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array "Array"
[boolean]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type "Boolean"
[Buffer]: https://nodejs.org/api/buffer.html#buffer_class_buffer "Buffer"
[ChildProcess]: https://nodejs.org/api/child_process.html "ChildProcess"
[Date]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date "Date"
[Error]: https://nodejs.org/api/errors.html#errors_class_error "Error"
[EventEmitter]: https://nodejs.org/api/events.html#events_class_eventemitter "EventEmitter"
[function]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function "Function"
[FormData]: https://developer.mozilla.org/en-US/docs/Web/API/FormData "FormData"
[Map]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map "Map"
[Metadata]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object "Object&lt;string, any&gt;"
[null]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/null "null"
[number]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type "Number"
[Object]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object "Object"
[Promise]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise "Promise"
[Readable]: https://nodejs.org/api/stream.html#stream_class_stream_readable "Readable"
[ReadStream]: https://nodejs.org/api/fs.html#class-fsreadstream "ReadStream"
[RegExp]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp "RegExp"
[string]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type "string"
[void]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/undefined "void"
[URL]: https://nodejs.org/api/url.html "URL"
[URLSearchParams]: https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams "URLSearchParams"

[all available image tags]: https://mcr.microsoft.com/en-us/product/playwright/about "all available image tags"
[Microsoft Artifact Registry]: https://mcr.microsoft.com/en-us/product/playwright/about "Microsoft Artifact Registry"
[Dockerfile.noble]: https://github.com/microsoft/playwright/blob/main/utils/docker/Dockerfile.noble "Dockerfile.noble"