---
id: aria-snapshots
title: "快照測試"
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import HTMLCard from '@site/src/components/HTMLCard';
import ProgressiveImage from '@theme/ProgressiveImage';

import LiteYouTube from '@site/src/components/LiteYouTube';

## 概述

透過 Playwright 的快照測試，您可以針對預定義的快照範本斷言頁面的無障礙樹。

```js
await page.goto('https://playwright.dev/');
await expect(page.getByRole('banner')).toMatchAriaSnapshot(`
  - banner:
    - heading /Playwright enables reliable end-to-end/ [level=1]
    - link "Get started"
    - link "Star microsoft/playwright on GitHub"
    - link /[\\d]+k\\+ stargazers on GitHub/
`);
```

<LiteYouTube id="P4R6hnsE0UY" title="Getting started with ARIA Snapshots" />

## 斷言測試 vs 快照測試

快照測試和斷言測試在測試自動化中有不同的用途：

### 斷言測試

斷言測試是一種針對性的方法，您可以斷言元素或元件的特定值或條件。例如，使用 Playwright 的 [expect(locator).toHaveText()](/api/class-locatorassertions.mdx#locator-assertions-to-have-text) 驗證元素包含預期文字，而 [expect(locator).toHaveValue()](/api/class-locatorassertions.mdx#locator-assertions-to-have-value) 則確認輸入欄位具有預期值。斷言測試是特定的，通常檢查元素或屬性的當前狀態與預期的預定義狀態。它們適用於可預測的單一值檢查，但在測試更廣泛的結構或變化時範圍有限。

**優點**
- **清晰度**：測試的意圖明確且易於理解。
- **特異性**：測試專注於功能的特定方面，使它們對無關變更更加穩健。
- **偵錯**：失敗提供有針對性的回饋，直接指向有問題的方面。

**缺點**
- **複雜輸出的冗長性**：為複雜資料結構或大型輸出編寫斷言可能很麻煩且容易出錯。
- **維護負擔**：隨著程式碼的發展，手動更新斷言可能很耗時。

### 快照測試

快照測試會在特定時刻捕獲元素、元件或資料的整個狀態的「快照」或表示法，然後儲存以供未來比較。重新執行測試時，會將當前狀態與快照進行比較，如果有差異，測試就會失敗。這種方法對於複雜或動態結構特別有用，因為手動斷言每個細節會過於耗時。快照測試比斷言測試更廣泛、更全面，讓您能夠追蹤更複雜的變更。

**優點**
- **簡化複雜輸出**：例如，使用傳統斷言測試 UI 元件的渲染輸出可能很繁瑣。快照可以捕獲整個輸出以便輕鬆比較。
- **快速回饋循環**：開發人員可以輕鬆發現輸出中的意外變更。
- **鼓勵一致性**：隨著程式碼的發展，有助於保持一致的輸出。

**缺點**
- **過度依賴**：可能會因為沒有完全理解快照的變更就接受它們而隱藏錯誤。
- **粒度**：當出現差異時，大型快照可能難以解釋，特別是在微小變更影響輸出的大部分時。
- **適用性**：不適合經常或不可預測地變更輸出的高度動態內容。

### 何時使用
- **快照測試**適用於：
  - 整個頁面和元件的 UI 測試。
  - 複雜 UI 元件的廣泛結構檢查。
  - 很少變更結構的輸出的回歸測試。
- **斷言測試**適用於：
  - 核心邏輯驗證。
  - 計算值測試。
  - 需要精確條件的細粒度測試。

透過結合用於廣泛結構檢查的快照測試和用於特定功能的斷言測試，您可以實現全面的測試策略。

## Aria 快照

在 Playwright 中，aria 快照提供頁面無障礙樹的 YAML 表示法。這些快照可以儲存並在之後進行比較，以驗證頁面結構是否保持一致或符合定義的期望。

YAML 格式描述了頁面上無障礙元素的階層結構，詳細說明了**角色**、**屬性**、**值**和**文字內容**。結構遵循樹狀語法，其中每個節點代表一個無障礙元素，縮排表示巢狀元素。

樹中的每個無障礙元素都表示為一個 YAML 節點：

```yaml
- role "name" [attribute=value]
```

- **role**：指定元素的 ARIA 或 HTML 角色（例如 `heading`、`list`、`listitem`、`button`）。
- **"name"**：元素的無障礙名稱。引號字串表示確切值，`/patterns/` 用於正規表示式。
- **[attribute=value]**：屬性和值，在方括號中，表示特定的 ARIA 屬性，例如 `checked`、`disabled`、`expanded`、`level`、`pressed` 或 `selected`。

這些值來自 ARIA 屬性或根據 HTML 語義計算。要檢查頁面的無障礙樹結構，請使用 [Chrome DevTools Accessibility Tab](https://developer.chrome.com/docs/devtools/accessibility/reference#tab)。

## 快照比對

Playwright 中的 [expect(locator).toMatchAriaSnapshot()](/api/class-locatorassertions.mdx#locator-assertions-to-match-aria-snapshot) 斷言方法會將定位器範圍的無障礙結構與預定義的 aria 快照範本進行比較，有助於根據測試需求驗證頁面狀態。

對於以下 DOM：

```html
<h1>title</h1>
```

您可以使用以下快照範本進行比對：

```js
await expect(page.locator('body')).toMatchAriaSnapshot(`
  - heading "title"
`);
```

比對時，快照範本會與頁面的當前無障礙樹進行比較：
* 如果樹結構符合範本，測試通過；否則測試失敗，表示預期和實際無障礙狀態之間不符。
* 比較區分大小寫並會摺疊空白字元，因此忽略縮排和換行符號。
* 比較對順序敏感，這意味著快照範本中元素的順序必須與頁面無障礙樹中的順序相符。

### 部分比對

您可以透過省略屬性或無障礙名稱對節點執行部分比對，從而能夠驗證無障礙樹的特定部分，而無需完全相符。這種靈活性對於動態或無關的屬性很有幫助。

```html
<button>Submit</button>
```

*aria snapshot*

```yaml
- button
```

在此範例中，button 角色會被比對，但未指定無障礙名稱（「Submit」），允許測試無論按鈕標籤為何都能通過。

<hr/>

對於具有 ARIA 屬性（如 `checked` 或 `disabled`）的元素，省略這些屬性允許部分比對，僅專注於角色和階層。

```html
<input type="checkbox" checked>
```

*aria snapshot for partial match*

```yaml
- checkbox
```

在此部分比對中，會忽略 `checked` 屬性，因此測試會通過，無論核取方塊的狀態如何。

<hr/>

同樣地，您可以透過省略特定清單項目或巢狀元素來部分比對清單或群組中的子項目。

```html
<ul>
  <li>Feature A</li>
  <li>Feature B</li>
  <li>Feature C</li>
</ul>
```

*aria snapshot for partial match*

```yaml
- list
  - listitem: Feature B
```

部分比對讓您能夠建立靈活的快照測試，驗證基本頁面結構而無需強制執行特定內容或屬性。

### 嚴格比對

預設情況下，包含子元素子集的範本將會被比對：

```html
<ul>
  <li>Feature A</li>
  <li>Feature B</li>
  <li>Feature C</li>
</ul>
```

*aria snapshot for partial match*

```yaml
- list
  - listitem: Feature B
```

`/children` 屬性可用於控制子元素的比對方式：
- `contain`（預設）：如果所有指定的子元素按順序存在則比對
- `equal`：如果子元素完全按順序符合指定清單則比對
- `deep-equal`：如果子元素完全按順序符合指定清單（包括巢狀子元素）則比對

```html
<ul>
  <li>Feature A</li>
  <li>Feature B</li>
  <li>Feature C</li>
</ul>
```

*aria snapshot will fail due to Feature C not being in the template*

```yaml
- list
  - /children: equal
  - listitem: Feature A
  - listitem: Feature B
```

### 使用正規表示式比對

正規表示式允許對具有動態或可變文字的元素進行靈活比對。無障礙名稱和文字可以支援正規表示式模式。

```html
<h1>Issues 12</h1>
```

*aria snapshot with regular expression*

```yaml
- heading /Issues \d+/
```

## 產生快照

在 Playwright 中建立 aria 快照有助於確保和維護您應用程式的結構。您可以根據測試設定和工作流程以各種方式產生快照。

### 使用 Playwright 程式碼產生器產生快照

如果您使用 Playwright 的 [程式碼產生器](./codegen.mdx)，透過其互動式介面產生 aria 快照會變得非常簡潔：
- **「Assert snapshot」動作**：在程式碼產生器中，您可以使用「Assert snapshot」動作為選定的元素自動建立快照斷言。這是將 aria 快照作為錄製測試流程一部分捕獲的快速方法。
- **「Aria snapshot」分頁**：程式碼產生器介面中的「Aria snapshot」分頁會視覺化地表示選定定位器的 aria 快照，讓您探索、檢查和驗證元素角色、屬性和無障礙名稱，以協助快照建立和檢閱。

### 使用 `@playwright/test` 和 `--update-snapshots` 旗標更新快照

使用 Playwright 測試執行器（`@playwright/test`）時，您可以使用 `--update-snapshots` 旗標（簡寫為 `-u`）自動更新快照。

執行帶有 `--update-snapshots` 旗標的測試將會更新不符合的快照。符合的快照不會被更新。

```bash
npx playwright test --update-snapshots
```

更新快照對於應用程式結構變更需要新快照作為基準時很有用。請注意，Playwright 會等待測試執行器設定中指定的最大預期逾時時間，以確保頁面在擷取快照前已穩定。如果測試在產生快照時逾時，可能需要調整 `--timeout`。

#### 用於快照產生的空範本

在斷言中傳遞空字串作為範本會即時產生快照：

```js
await expect(locator).toMatchAriaSnapshot('');
```

請注意，Playwright 會等待測試執行器設定中指定的最大預期逾時時間，以確保頁面在擷取快照前已穩定。如果測試在產生快照時逾時，可能需要調整 `--timeout`。

#### 快照修補檔案

更新快照時，Playwright 會建立捕獲差異的修補檔案。這些修補檔案可以被檢閱、套用並提交到版本控制系統，讓團隊能夠追蹤隨時間變化的結構變更，並確保更新與應用程式需求保持一致。

可以使用 `--update-source-method` 旗標變更原始碼更新方式。有幾個可用選項：
- **"patch"**（預設）：產生可使用 `git apply` 套用到原始碼的統一差異檔案。
- **"3way"**：在您的原始碼中產生合併衝突標記，讓您選擇是否接受變更。
- **"overwrite"**：使用新的快照值覆寫原始碼。

```bash
npx playwright test --update-snapshots --update-source-method=3way
```

#### 快照作為獨立檔案

要將快照儲存在獨立檔案中，請使用 `toMatchAriaSnapshot` 方法搭配 `name` 選項，指定 `.aria.yml` 副檔名。

```js
await expect(page.getByRole('main')).toMatchAriaSnapshot({ name: 'main.aria.yml' });
```

預設情況下，來自測試檔案 `example.spec.ts` 的快照會放置在 `example.spec.ts-snapshots` 目錄中。由於快照在不同瀏覽器間應該相同，即使使用多個瀏覽器進行測試，也只會儲存一個快照。如果您希望，可以使用以下設定自訂[快照路徑範本](./api/class-testconfig#test-config-snapshot-path-template)：

```js
export default defineConfig({
  expect: {
    toMatchAriaSnapshot: {
      pathTemplate: '__snapshots__/{testFilePath}/{arg}{ext}',
    },
  },
});
```

### 使用 `Locator.ariaSnapshot` 方法

[locator.ariaSnapshot()](/api/class-locator.mdx#locator-aria-snapshot) 方法讓您能夠以程式化方式建立定位器範圍內無障礙元素的 YAML 表示法，這對於在測試執行期間動態產生快照特別有幫助。

**Example**:

```js
const snapshot = await page.locator('body').ariaSnapshot();
console.log(snapshot);
```

此指令會以 YAML 格式輸出指定定位器範圍內的 aria 快照，您可以根據需要進行驗證或儲存。

## 無障礙樹範例

### 具有層級屬性的標題

標題可以包含指示其標題層級的 `level` 屬性。

```html
<h1>Title</h1>
<h2>Subtitle</h2>
```

*aria snapshot*

```yaml
- heading "Title" [level=1]
- heading "Subtitle" [level=2]
```

### 文字節點

獨立或描述性文字元素會顯示為文字節點。

```html
<div>Sample accessible name</div>
```

*aria snapshot*

```yaml
- text: Sample accessible name
```

### 行內多行文字

多行文字（如段落）在 aria 快照中會被正規化。

```html
<p>Line 1<br>Line 2</p>
```

*aria snapshot*

```yaml
- paragraph: Line 1 Line 2
```

### 連結

連結會顯示其文字或由偽元素組成的內容。

```html
<a href="#more-info">Read more about Accessibility</a>
```

*aria snapshot*

```yaml
- link "Read more about Accessibility"
```

### 文字方塊

類型為 `text` 的輸入元素會顯示其 `value` 屬性內容。

```html
<input type="text" value="Enter your name">
```

*aria snapshot*

```yaml
- textbox: Enter your name
```

### 含項目的清單

有序和無序清單包含其清單項目。

```html
<ul aria-label="Main Features">
  <li>Feature 1</li>
  <li>Feature 2</li>
</ul>
```

*aria snapshot*

```yaml
- list "Main Features":
  - listitem: Feature 1
  - listitem: Feature 2
```

### 群組元素

群組會捕獲巢狀元素，例如包含摘要內容的 `<details>` 元素。

```html
<details>
  <summary>Summary</summary>
  <p>Detail content here</p>
</details>
```

*aria snapshot*

```yaml
- group: Summary
```

### 屬性和狀態

常用的 ARIA 屬性，如 `checked`、`disabled`、`expanded`、`level`、`pressed` 和 `selected`，代表控制項狀態。

#### 帶有 `checked` 屬性的核取方塊

```html
<input type="checkbox" checked>
```

*aria snapshot*

```yaml
- checkbox [checked]
```

#### 帶有 `pressed` 屬性的按鈕

```html
<button aria-pressed="true">Toggle</button>
```

*aria snapshot*

```yaml
- button "Toggle" [pressed=true]
```


[Accessibility]: /api/class-accessibility.mdx "Accessibility"
[Android]: /api/class-android.mdx "Android"
[AndroidDevice]: /api/class-androiddevice.mdx "AndroidDevice"
[AndroidInput]: /api/class-androidinput.mdx "AndroidInput"
[AndroidSocket]: /api/class-androidsocket.mdx "AndroidSocket"
[AndroidWebView]: /api/class-androidwebview.mdx "AndroidWebView"
[APIRequest]: /api/class-apirequest.mdx "APIRequest"
[APIRequestContext]: /api/class-apirequestcontext.mdx "APIRequestContext"
[APIResponse]: /api/class-apiresponse.mdx "APIResponse"
[APIResponseAssertions]: /api/class-apiresponseassertions.mdx "APIResponseAssertions"
[Browser]: /api/class-browser.mdx "Browser"
[BrowserContext]: /api/class-browsercontext.mdx "BrowserContext"
[BrowserServer]: /api/class-browserserver.mdx "BrowserServer"
[BrowserType]: /api/class-browsertype.mdx "BrowserType"
[CDPSession]: /api/class-cdpsession.mdx "CDPSession"
[Clock]: /api/class-clock.mdx "Clock"
[ConsoleMessage]: /api/class-consolemessage.mdx "ConsoleMessage"
[Coverage]: /api/class-coverage.mdx "Coverage"
[Dialog]: /api/class-dialog.mdx "Dialog"
[Download]: /api/class-download.mdx "Download"
[Electron]: /api/class-electron.mdx "Electron"
[ElectronApplication]: /api/class-electronapplication.mdx "ElectronApplication"
[ElementHandle]: /api/class-elementhandle.mdx "ElementHandle"
[FileChooser]: /api/class-filechooser.mdx "FileChooser"
[Frame]: /api/class-frame.mdx "Frame"
[FrameLocator]: /api/class-framelocator.mdx "FrameLocator"
[GenericAssertions]: /api/class-genericassertions.mdx "GenericAssertions"
[JSHandle]: /api/class-jshandle.mdx "JSHandle"
[Keyboard]: /api/class-keyboard.mdx "Keyboard"
[Locator]: /api/class-locator.mdx "Locator"
[LocatorAssertions]: /api/class-locatorassertions.mdx "LocatorAssertions"
[Logger]: /api/class-logger.mdx "Logger"
[Mouse]: /api/class-mouse.mdx "Mouse"
[Page]: /api/class-page.mdx "Page"
[PageAssertions]: /api/class-pageassertions.mdx "PageAssertions"
[Playwright]: /api/class-playwright.mdx "Playwright"
[PlaywrightAssertions]: /api/class-playwrightassertions.mdx "PlaywrightAssertions"
[Request]: /api/class-request.mdx "Request"
[Response]: /api/class-response.mdx "Response"
[Route]: /api/class-route.mdx "Route"
[Selectors]: /api/class-selectors.mdx "Selectors"
[SnapshotAssertions]: /api/class-snapshotassertions.mdx "SnapshotAssertions"
[TimeoutError]: /api/class-timeouterror.mdx "TimeoutError"
[Touchscreen]: /api/class-touchscreen.mdx "Touchscreen"
[Tracing]: /api/class-tracing.mdx "Tracing"
[Video]: /api/class-video.mdx "Video"
[WebError]: /api/class-weberror.mdx "WebError"
[WebSocket]: /api/class-websocket.mdx "WebSocket"
[WebSocketRoute]: /api/class-websocketroute.mdx "WebSocketRoute"
[Worker]: /api/class-worker.mdx "Worker"
[Fixtures]: /api/class-fixtures.mdx "Fixtures"
[FullConfig]: /api/class-fullconfig.mdx "FullConfig"
[FullProject]: /api/class-fullproject.mdx "FullProject"
[Location]: /api/class-location.mdx "Location"
[Test]: /api/class-test.mdx "Test"
[TestConfig]: /api/class-testconfig.mdx "TestConfig"
[TestInfo]: /api/class-testinfo.mdx "TestInfo"
[TestInfoError]: /api/class-testinfoerror.mdx "TestInfoError"
[TestOptions]: /api/class-testoptions.mdx "TestOptions"
[TestProject]: /api/class-testproject.mdx "TestProject"
[TestStepInfo]: /api/class-teststepinfo.mdx "TestStepInfo"
[WorkerInfo]: /api/class-workerinfo.mdx "WorkerInfo"
[Reporter]: /api/class-reporter.mdx "Reporter"
[Suite]: /api/class-suite.mdx "Suite"
[TestCase]: /api/class-testcase.mdx "TestCase"
[TestError]: /api/class-testerror.mdx "TestError"
[TestResult]: /api/class-testresult.mdx "TestResult"
[TestStep]: /api/class-teststep.mdx "TestStep"
[Element]: https://developer.mozilla.org/en-US/docs/Web/API/element "Element"
[EvaluationArgument]: /evaluating.mdx#evaluation-argument "EvaluationArgument"
[Promise]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise "Promise"
[iterator]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols "Iterator"
[origin]: https://developer.mozilla.org/en-US/docs/Glossary/Origin "Origin"
[selector]: https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors "selector"
[Serializable]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify#Description "Serializable"
[UIEvent.detail]: https://developer.mozilla.org/en-US/docs/Web/API/UIEvent/detail "UIEvent.detail"
[UnixTime]: https://en.wikipedia.org/wiki/Unix_time "Unix Time"
[xpath]: https://developer.mozilla.org/en-US/docs/Web/XPath "xpath"

[Array]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array "Array"
[boolean]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type "Boolean"
[Buffer]: https://nodejs.org/api/buffer.html#buffer_class_buffer "Buffer"
[ChildProcess]: https://nodejs.org/api/child_process.html "ChildProcess"
[Date]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date "Date"
[Error]: https://nodejs.org/api/errors.html#errors_class_error "Error"
[EventEmitter]: https://nodejs.org/api/events.html#events_class_eventemitter "EventEmitter"
[function]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function "Function"
[FormData]: https://developer.mozilla.org/en-US/docs/Web/API/FormData "FormData"
[Map]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map "Map"
[Metadata]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object "Object&lt;string, any&gt;"
[null]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/null "null"
[number]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type "Number"
[Object]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object "Object"
[Promise]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise "Promise"
[Readable]: https://nodejs.org/api/stream.html#stream_class_stream_readable "Readable"
[ReadStream]: https://nodejs.org/api/fs.html#class-fsreadstream "ReadStream"
[RegExp]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp "RegExp"
[string]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type "string"
[void]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/undefined "void"
[URL]: https://nodejs.org/api/url.html "URL"
[URLSearchParams]: https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams "URLSearchParams"

[all available image tags]: https://mcr.microsoft.com/en-us/product/playwright/about "all available image tags"
[Microsoft Artifact Registry]: https://mcr.microsoft.com/en-us/product/playwright/about "Microsoft Artifact Registry"
[Dockerfile.noble]: https://github.com/microsoft/playwright/blob/main/utils/docker/Dockerfile.noble "Dockerfile.noble"
